

---

## **项目设计文档：ankityping 插件**

### 1. 项目概述

**1.1 项目名称**
ankityping

**1.2 核心功能**
ankityping 是一个为语言学习者设计的 Anki 插件，它提供一个基于 PyQt 的沉浸式“逐字输入句子”练习模式。插件从 Anki 卡片中提取目标句子和可选的提示信息，并在一个专用的界面中要求用户完整、准确地敲出该句子。系统提供实时的视觉反馈、智能的错误处理、性能统计，并根据用户的练习表现智能地评定分数，无缝集成回 Anki 的间隔重复（SRS）系统中，以增强学习效果。

### 2. 核心功能规格

**2.1 V1.0 核心功能集**

*   **F-01: 卡片数据提取**
    *   插件能够从当前复习的 Anki 卡片中，根据用户配置的字段名，读取提示、目标句子和可选的音频文件路径。

*   **F-02: 沉浸式输入界面**
    *   呈现一个专注、无干扰的 PyQt 练习窗口，清晰展示：
        *   **提示区：** 显示源语言句子或其他提示信息。
        *   **练习区：** 动态渲染目标句子，每个字符根据用户输入实时改变视觉状态。
        *   **状态栏：** 实时显示计时器和错误次数。
        *   **控制区：** 包含“提示”和“放弃”按钮。

*   **F-03: 实时视觉反馈系统**
    *   练习区中的每个字符都具有以下三种核心视觉状态：
        *   **已正确输入：** 绿色字体。
        *   **当前待输入：** 高亮（如下划线）。
        *   **未输入：** 灰色占位符（如 `-`）。
    *   错误输入时，整个练习区背景短暂闪红，提供即时、非侵入性的反馈。

*   **F-04: 灵活的错误处理与重置机制**
    *   输入错误时，提供明确的视觉和（可选的）音频反馈。
    *   重置策略可配置：
        *   **按句子重置：** 清空所有已输入内容。
        *   **按单词重置：** 仅重置当前正在输入的单词。

*   **F-05: 练习完成与智能评分**
    *   当用户正确输入整个句子时，练习完成。
    *   系统根据总耗时、错误次数和提示使用次数，综合计算出一个表现评分。
    *   该评分被映射为 Anki 的四个难度等级（重来、困难、良好、简单），实现智能化的学习进度调整。

*   **F-06: Anki SRS 深度集成**
    *   练习完成后，插件自动调用 Anki 的 API 提交评分，并触发跳转到下一张卡片，流程无缝衔接。
    *   可选地将本次练习的详细统计数据（耗时、错误数）写入卡片的指定字段，用于长期追踪和分析。

*   **F-07: 可选音频支持**
    *   如果配置了音频字段，练习开始时自动播放目标句子的音频，支持听写练习模式。

**2.2 V1.1+ 扩展功能集**

*   **F-08: 分级智能提示系统**
    *   提供多级提示：显示当前字符、当前单词、整个句子。
    *   使用提示会记录在案，并影响最终评分，鼓励用户独立回忆。

*   **F-09: 用户友好的配置管理界面**
    *   提供一个图形化设置窗口，允许用户轻松配置所有选项，无需手动编辑 JSON 文件。
    *   配置项包括字段映射、重置策略、界面主题、音效开关等。

*   **F-10: 主题系统**
    *   内置亮色和暗色主题，用户可根据偏好切换。

### 3. 系统架构设计

项目采用模块化架构，将核心业务逻辑、Anki 交互和用户界面清晰分离，便于维护和扩展。项目结构遵循现代 Python 包管理工具（如 `uv`）的最佳实践。

**3.1 项目目录结构**

```
ankityping/
├── pyproject.toml         # 项目元数据和依赖定义 (用于 uv)
├── README.md
├── manifest.json          # Anki 插件清单文件
└── src/
    └── ankityping/
        ├── __init__.py         # 插件入口点，负责初始化和添加菜单项
        ├── anki_integration.py # 封装所有与 Anki 核心的 API 交互
        ├── config.py           # 配置模型的定义和管理逻辑
        ├── core/               # 核心业务逻辑模块，与 UI 和 Anki 解耦
        │   ├── __init__.py
        │   ├── typing_engine.py  # 核心打字引擎：状态管理、输入比对
        │   ├── stats.py          # 统计数据收集器
        │   └── hint.py           # 提示管理器
        └── ui/                 # 用户界面模块
            ├── __init__.py
            ├── typing_dialog.py  # 主要的打字练习窗口
            └── config_dialog.py  # 配置管理窗口
```

**3.2 架构组件详解**

1.  **`anki_integration.py`**
    *   **职责：** 作为插件与 Anki 之间的唯一桥梁。
    *   **功能：** 获取当前卡片数据、提取字段内容、调用 `mw.col.sched.answerCard` 提交答案、调用 `mw.reviewer.nextCard` 切换卡片、将统计数据写入卡片字段。
    *   **依赖：** `anki`, `aqt`

2.  **`config.py`**
    *   **职责：** 管理插件的所有配置。
    *   **功能：** 定义配置数据模型，使用 Anki 的 `addonManager.getConfig` 和 `addonManager.writeConfig` 读取和写入配置，提供默认值。
    *   **依赖：** `aqt`

3.  **`core/` (核心业务逻辑)**
    *   **`typing_engine.py`：** 练习模式的核心。管理目标句子、当前输入位置、输入状态（正确/错误/完成）。接收键盘输入，比对目标字符，并返回状态更新指令。
    *   **`stats.py`：** `StatsCollector` 类。负责管理计时器（使用 `QTimer`）、错误计数器和提示使用计数器。
    *   **`hint.py`：** `HintManager` 类。管理提示逻辑，计算并返回不同级别的提示内容。
    *   **依赖：** `PyQt6`

4.  **`ui/` (用户界面)**
    *   **`typing_dialog.py`：** `TypingDialog` 类（继承自 `QDialog`）。这是用户看到的主界面。它负责：
        *   布局和渲染所有 UI 组件（`QLabel`, `QTextEdit`, `QPushButton` 等）。
        *   捕获键盘事件 (`keyPressEvent`) 并委托给 `core.typing_engine`。
        *   接收 `typing_engine` 的状态更新，并使用富文本（HTML）刷新 `QTextEdit` 的显示。
        *   协调 `core.stats` 和 `core.hint` 模块。
        *   在练习完成或放弃时，调用 `anki_integration` 模块的方法。
    *   **`config_dialog.py`：** `ConfigDialog` 类（继承自 `QDialog`）。提供一个表单界面，让用户可视化地修改所有配置项，并保存。
    *   **依赖：** `PyQt6`, `aqt`, `anki` (用于获取字段列表等)

5.  **`__init__.py`**
    *   **职责：** 插件的启动脚本。
    *   **功能：** 在 Anki 加载时执行，向 Anki 的“工具”菜单添加一个动作，该动作用于打开 `typing_dialog.py`。
    *   **依赖：** `aqt`

**3.3 数据流**

1.  **启动：** 用户点击菜单项 -> `__init__.py` 被触发 -> 实例化 `TypingDialog`。
2.  **初始化：** `TypingDialog` -> 调用 `anki_integration.get_card_data()` -> 调用 `config.py` 获取配置 -> 初始化 `core` 模块 -> 渲染初始 UI。
3.  **交互循环：** 用户按键 -> `TypingDialog.keyPressEvent()` -> `TypingEngine.process_input()` -> 返回状态（正确/错误/完成） -> `TypingDialog` 更新 UI / `StatsCollector` 记录数据。
4.  **完成/放弃：** `TypingDialog` -> 从 `StatsCollector` 获取最终数据 -> 调用 `anki_integration.submit_answer_and_stats()` -> `anki_integration` 与 Anki 交互 -> `TypingDialog` 关闭。

### 4. 数据模型与配置

**4.1 配置与数据分离原则**

插件的配置文件 (`config.json`) **仅存储用户设置**，不存储任何单次练习的过程数据。过程数据（如耗时、错误数）仅在内存中临时存在，用于最终评分，并可选地作为结果写入卡片字段。

**4.2 插件配置模型(可适当扩展一些界面设置如窗口大小等，界面是否置顶、、、)**

```json
{
  "ui": {
    "theme": "dark" // "light" or "dark"
  },
  "behavior": {
    "resetMode": "sentence", // "sentence" or "word"
    "soundEnabled": true,
    "autoPlayAudio": true
  },
  "fieldMapping": {
    "prompt": "Front",
    "target": "Back",
    "audio": "Audio" // 可选，用于听写
  },
}
```

**4.3 Anki 卡片字段约定**

| 字段类型 | 推荐字段名 | 用途 | 是否必需 |
| --- | --- | --- | --- |
| **输入字段** | `Front` | 作为练习的提示 | 是 |
| **输入字段** | `Back` | 作为输入的目标 | 是 |
| **输入字段** | `Audio` | 存储音频文件名或链接 | 否 |

### 5. 用户界面设计

**5.1 打字练习窗口 (`TypingDialog`)**

*   **布局：** 垂直布局，简洁专注。
*   **组件：**
    *   提示 `QLabel`
    *   练习区 `QTextEdit` (只读，用于富文本渲染)
    *   状态栏 `QLabel` (显示 "准备开始..."、"用时: Xs, 错误: Y次")
    *   控制 `QHBoxLayout` (包含 "提示" 和 "放弃" `QPushButton`)
*   **交互：** 全局键盘监听，即时视觉反馈。

**5.2 配置管理窗口 (`ConfigDialog`)**

*   **布局：** 表单式布局，清晰直观。
*   **组件：**
    *   **字段映射：** 使用 `QComboBox` 下拉菜单，动态加载当前笔记类型的所有字段，供用户选择。
    *   **行为设置：** 使用 `QRadioButton` 组（重置模式）和 `QCheckBox`（音效开关）。
    *   **主题设置：** 使用 `QRadioButton` 组。
    *   **按钮：** "确定" (保存并关闭), "取消" (关闭不保存), "恢复默认"。

### 6. 实现说明

*   **依赖管理：** 使用 `pyproject.toml` 明确项目依赖，主要是 `PyQt6`。Anki 插件运行时，`aqt` 和 `anki` 是由 Anki 本身提供的，无需在 `pyproject.toml` 中声明。
*   **编码规范：** 遵循 PEP 8，使用类型提示，编写清晰的文档字符串。
*   **无硬编码：** 所有字符串、默认值、样式等均通过配置文件或常量定义，提高可维护性。
*   **可扩展性：** 模块化设计使得未来添加新功能（如新的评分算法、更多练习模式）变得简单，只需在 `core` 或 `ui` 下添加新模块，而无需修改现有核心逻辑。
